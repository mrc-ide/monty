<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Build a parameter packer — mcstate_packer • mcstate2</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Build a parameter packer — mcstate_packer"><meta name="description" content='Build a parameter packer, which can be used in models to translate
between an unstructured vector of numbers (the vector being
updated by an MCMC for example) to a structured list of named
values, which is easier to program against.  We refer to the
process of taking a named list of scalars, vectors and arrays and
converting into a single vector "packing" and the inverse
"unpacking".'><meta property="og:description" content='Build a parameter packer, which can be used in models to translate
between an unstructured vector of numbers (the vector being
updated by an MCMC for example) to a structured list of named
values, which is easier to program against.  We refer to the
process of taking a named list of scalars, vectors and arrays and
converting into a single vector "packing" and the inverse
"unpacking".'></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mcstate2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/mcstate2.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/dsl-errors.html">DSL parse errors</a></li>
    <li><a class="dropdown-item" href="../articles/dsl.html">Probabilistic DSL</a></li>
    <li><a class="dropdown-item" href="../articles/samplers.html">Samplers</a></li>
    <li><a class="dropdown-item" href="../articles/samples.html">Working with samples</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/mcstate2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Build a parameter packer</h1>
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/mcstate2/blob/main/R/packer.R" class="external-link"><code>R/packer.R</code></a></small>
      <div class="d-none name"><code>mcstate_packer.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Build a parameter packer, which can be used in models to translate
between an unstructured vector of numbers (the vector being
updated by an MCMC for example) to a structured list of named
values, which is easier to program against.  We refer to the
process of taking a named list of scalars, vectors and arrays and
converting into a single vector "packing" and the inverse
"unpacking".</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mcstate_packer</span><span class="op">(</span>scalar <span class="op">=</span> <span class="cn">NULL</span>, array <span class="op">=</span> <span class="cn">NULL</span>, fixed <span class="op">=</span> <span class="cn">NULL</span>, process <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-scalar">scalar<a class="anchor" aria-label="anchor" href="#arg-scalar"></a></dt>
<dd><p>Names of scalar parameters.  This is similar for
listing elements in <code>array</code> with values of 1, though elements in
<code>scalar</code> will be placed ahead of those listed in <code>array</code> within
the final parameter vector, and elements in <code>array</code> will have
generated names that include square brackets.</p></dd>


<dt id="arg-array">array<a class="anchor" aria-label="anchor" href="#arg-array"></a></dt>
<dd><p>A list, where names correspond to the names of array
parameters and values correspond to the lengths of parameters.
Multiple dimensions are allowed (so if you provide an element
with two entries these represent dimensions of a matrix).
Zero-length integer vectors or <code>NULL</code> values are counted as
scalars, which allows you to put scalars at positions other than
the front of the packing vector. In future, you may be able to
use <em>strings</em> as values for the lengths, in which case these
will be looked for within <code>fixed</code>.</p></dd>


<dt id="arg-fixed">fixed<a class="anchor" aria-label="anchor" href="#arg-fixed"></a></dt>
<dd><p>A named list of fixed parameters; these will be added
into the final list directly.  These typically represent
additional pieces of data that your model needs to run, but
which you are not performing inference on.</p></dd>


<dt id="arg-process">process<a class="anchor" aria-label="anchor" href="#arg-process"></a></dt>
<dd><p>An arbitrary R function that will be passed the
final assembled parameter list; it may create any <em>additional</em>
entries, which will be concatenated onto the original list.  If
you use this you should take care not to return any values with
the same names as entries listed in <code>scalar</code>, <code>array</code> or
<code>fixed</code>, as this is an error (this is so that <code>pack()</code> is
not broken).  We will likely play around with this process in
future in order to get automatic differentiation to work.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An object of class <code>mcstate_packer</code>, which has three
elements:</p><ul><li><p><code>parameters</code>: a character vector of computed parameter names;
these are the names that your statistical model will use.</p></li>
<li><p><code>unpack</code>: a function that can unpack an unstructured vector
(say, from your statistical model parameters) into a structured
list (say, for your generative model)</p></li>
<li><p><code>pack</code>: a function that can pack your structured list of
parameters back into a numeric vector suitable for the
statistical model.  This ignores values created by a
<code>preprocess</code> function.</p></li>
<li><p><code>index</code>: a function which produces a named list where each
element has the name of a value in <code>parameters</code> and each value
has the indices within an unstructured vector where these values
can be found.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>There are several places where it is most convenient to work in an
unstructured vector:</p><ul><li><p>An MCMC is typically discussed as a the updating of some
vector <code>x</code> to another <code>x'</code></p></li>
<li><p>An optimisation algorithm will try and find a set of values for
a vector <code>x</code> that minimises (or maximises) some function <code>f(x)</code></p></li>
<li><p>An ode solver works with a vector <code>x(t)</code> (<code>x</code> at time <code>t</code>) and
considers <code>x(t + h)</code> by computing the vector of derivatives
<code>dx(t)/dt</code></p></li>
</ul><p>In all these cases, the algorithm that needs the vector of numbers
knows nothing about what they represent.  Commonly, these will be
a packed vector of parameters.  So our vector <code>x</code> might actually
represent the parameters <code>a</code>, <code>b</code> and <code>c</code> in a vector as <code>[a, b, c]</code> - this is a very common pattern, and you have probably
implemented this yourself.</p>
<p>In more complex settings, we might want our vector <code>x</code> to collect
more structured quantities.  Suppose that you are fitting a model
with an age-structured or sex-structured parameter.  Rather than
having a series of scalars packed into your vector <code>x</code> you might
have a series of values destined to be treated as a vector:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="sc">|</span> <span class="dv">1</span>  <span class="dv">2</span>  <span class="dv">3</span>  <span class="dv">4</span>  <span class="dv">5</span>  <span class="dv">6</span>  <span class="dv">7</span>  <span class="sc">|</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="er">|</span> a  b  c  d1 d2 d3 d4 <span class="sc">|</span></span></code></pre><p></p></div>
<p>So here we might have a vector of length 7, where the first three
elements will represent be the scalar values <code>a</code>, <code>b</code> and <code>c</code> but
the next four will be a vector <code>d</code>.</p>
<p>Unpacked, this might be written as:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">list</span>(<span class="at">a =</span> <span class="dv">1</span>, <span class="at">b =</span> <span class="dv">2</span>, <span class="at">c =</span> <span class="dv">3</span>, <span class="at">d =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">7</span>)</span></code></pre><p></p></div>
<p>The machinery here is designed to make these transformations
simple and standardised within mcstate2, and should be flexible
enough for many situations.  We will also use these from within
<code>dust2</code> and <code>odin2</code> for transformations in and out of vectors of
ODE state.</p>
    </div>
    <div class="section level2">
    <h2 id="when-to-use-process">When to use <code>process</code><a class="anchor" aria-label="anchor" href="#when-to-use-process"></a></h2>
    <p>The <code>process</code> function is a get-out-of-jail function designed to
let you do arbitrary transformations when unpacking a vector.  In
general, this should not be the first choice to use because it is
less easy to reason about by other tooling (for example, as we
develop automatic differentiation support for use with the HMC
algorithm, a <code>process</code> function will be problematic because we
will need to make sure we can differentiate this process).
However, there are cases where it will be only way to achieve some
results.</p>
<p>Imagine that you are packing a 2x2 covariance matrix into your
vector in order to use within an MCMC or optimisation algorithm.
Ultimately, our unpacked vector will need to hold four elements
(<code>b11</code>, <code>b12</code>, <code>b21</code>, <code>b22</code>), but there are only three distinct
values as the two off-diagonal elements will be the same (i.e.,
<code>b12 == b21``).  So we might write this passing in </code>b_raw = 3<code>to</code>array<code>, so that our unpacked list holds </code>b_raw = c(b11, b12,
b22)<code>.  We would then write </code>process` as something like:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>process <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">b =</span> <span class="fu">matrix</span>(x<span class="sc">$</span>b_raw[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>)], <span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>}</span></code></pre><p></p></div>
<p>which creates the symmetric 2x2 matrix <code>b</code> from <code>b_raw</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="unpacking-matrices">Unpacking matrices<a class="anchor" aria-label="anchor" href="#unpacking-matrices"></a></h2>
    <p>If you do not use <code>fixed</code> or <code>process</code> when defining your packer,
then you can use <code>$unpack()</code> with a matrix or higher-dimensional
output.  There are two ways that you might like to unpack this
sort of output.  Assume you have a matrix <code>m</code> with 3 rows and 2
columns; this means that we have two sets of parameters or state
(one per column) and 3 states within each; this is the format that
mcmc parameters will be in for example.</p>
<p>The first would to be return a list where the <code>i</code>th element is the
result of unpacking the <code>i</code>th parameter/state vector.  You can do
this by running</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">apply</span>(m, <span class="dv">2</span>, p<span class="sc">$</span>unpack)</span></code></pre><p></p></div>
<p>The second would be to return a named list with three elements
where the <code>ith</code> element is the unpacked version of the <code>i</code>th
state.  In this case you can pass the matrix directly in to the
unpacker:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>p<span class="sc">$</span><span class="fu">unpack</span>(m)</span></code></pre><p></p></div>
<p>When you do this, the elements of <code>m</code> will acquire an additional
dimension; scalars become vectors (one per set), vectors become
matrices (one column per set) and so on.</p>
<p>This approach generalises to higher dimensional input, though we
suspect you'll spend a bit of time headscratching if you use it.</p>
<p>We do not currently offer the ability to pack this sort of output
back up, though it's not hard.  Please let us know if you would
use this.</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

