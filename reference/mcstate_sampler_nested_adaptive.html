<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Nested Adaptive Metropolis-Hastings Sampler — mcstate_sampler_nested_adaptive • mcstate2</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Nested Adaptive Metropolis-Hastings Sampler — mcstate_sampler_nested_adaptive"><meta name="description" content="Create a nested adaptive Metropolis-Hastings sampler, which extends the
adaptive sampler mcstate_sampler_adaptive, tuning the variance covariance
matrices for proposal for the separable sections
of a nested model (vs the simple nested random walk sampler
mcstate_sampler_random_walk). This sampler requires
that models support the has_parameter_groups property."><meta property="og:description" content="Create a nested adaptive Metropolis-Hastings sampler, which extends the
adaptive sampler mcstate_sampler_adaptive, tuning the variance covariance
matrices for proposal for the separable sections
of a nested model (vs the simple nested random walk sampler
mcstate_sampler_random_walk). This sampler requires
that models support the has_parameter_groups property."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mcstate2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/mcstate2.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/dsl-errors.html">DSL parse errors</a></li>
    <li><a class="dropdown-item" href="../articles/dsl.html">Probabilistic DSL</a></li>
    <li><a class="dropdown-item" href="../articles/samplers.html">Samplers</a></li>
    <li><a class="dropdown-item" href="../articles/samples.html">Working with samples</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/mcstate2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Nested Adaptive Metropolis-Hastings Sampler</h1>
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/mcstate2/blob/main/R/sampler-nested-adaptive.R" class="external-link"><code>R/sampler-nested-adaptive.R</code></a></small>
      <div class="d-none name"><code>mcstate_sampler_nested_adaptive.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Create a nested adaptive Metropolis-Hastings sampler, which extends the
adaptive sampler <a href="mcstate_sampler_adaptive.html">mcstate_sampler_adaptive</a>, tuning the variance covariance
matrices for proposal for the separable sections
of a nested model (vs the simple nested random walk sampler
<a href="mcstate_sampler_random_walk.html">mcstate_sampler_random_walk</a>). This sampler requires
that models support the <code>has_parameter_groups</code> property.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mcstate_sampler_nested_adaptive</span><span class="op">(</span></span>
<span>  <span class="va">initial_vcv</span>,</span>
<span>  initial_vcv_weight <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  initial_scaling <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  initial_scaling_weight <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  min_scaling <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  scaling_increment <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  log_scaling_update <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  acceptance_target <span class="op">=</span> <span class="fl">0.234</span>,</span>
<span>  forget_rate <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  forget_end <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  adapt_end <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  pre_diminish <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-initial-vcv">initial_vcv<a class="anchor" aria-label="anchor" href="#arg-initial-vcv"></a></dt>
<dd><p>An initial variance covariance matrix; we'll start
using this in the proposal, which will gradually become more weighted
towards the empirical covariance matrix calculated from the chain.</p></dd>


<dt id="arg-initial-vcv-weight">initial_vcv_weight<a class="anchor" aria-label="anchor" href="#arg-initial-vcv-weight"></a></dt>
<dd><p>Weight of the initial variance-covariance
matrix used to build the proposal of the random-walk. Higher
values translate into higher confidence of the initial
variance-covariance matrix and means that update from additional
samples will be slower.</p></dd>


<dt id="arg-initial-scaling">initial_scaling<a class="anchor" aria-label="anchor" href="#arg-initial-scaling"></a></dt>
<dd><p>The initial scaling of the variance
covariance matrix to be used to generate the multivariate normal
proposal for the random-walk Metropolis-Hastings algorithm. To generate
the proposal matrix, the weighted variance covariance matrix is
multiplied by the scaling parameter squared times 2.38^2 / n_pars (where
n_pars is the number of fitted parameters). Thus, in a Gaussian target
parameter space, the optimal scaling will be around 1.</p></dd>


<dt id="arg-initial-scaling-weight">initial_scaling_weight<a class="anchor" aria-label="anchor" href="#arg-initial-scaling-weight"></a></dt>
<dd><p>The initial weight used in the scaling update.
The scaling weight will increase after the first <code>pre_diminish</code>
iterations, and as the scaling weight increases the adaptation of the
scaling diminishes. If <code>NULL</code> (the default) the value is
5 / (acceptance_target * (1 - acceptance_target)).</p></dd>


<dt id="arg-min-scaling">min_scaling<a class="anchor" aria-label="anchor" href="#arg-min-scaling"></a></dt>
<dd><p>The minimum scaling of the variance covariance
matrix to be used to generate the multivariate normal proposal
for the random-walk Metropolis-Hastings algorithm.</p></dd>


<dt id="arg-scaling-increment">scaling_increment<a class="anchor" aria-label="anchor" href="#arg-scaling-increment"></a></dt>
<dd><p>The scaling increment which is added or
subtracted to the scaling factor of the variance-covariance
after each adaptive step. If <code>NULL</code> (the default) then an optimal
value will be calculated.</p></dd>


<dt id="arg-log-scaling-update">log_scaling_update<a class="anchor" aria-label="anchor" href="#arg-log-scaling-update"></a></dt>
<dd><p>Logical, whether or not changes to the
scaling parameter are made on the log-scale.</p></dd>


<dt id="arg-acceptance-target">acceptance_target<a class="anchor" aria-label="anchor" href="#arg-acceptance-target"></a></dt>
<dd><p>The target for the fraction of proposals
that should be accepted (optimally) for the adaptive part of the
chain.</p></dd>


<dt id="arg-forget-rate">forget_rate<a class="anchor" aria-label="anchor" href="#arg-forget-rate"></a></dt>
<dd><p>The rate of forgetting early parameter sets from the
empirical variance-covariance matrix in the MCMC chains. For example,
<code>forget_rate = 0.2</code> (the default) means that once in every 5th iterations
we remove the earliest parameter set included, so would remove the 1st
parameter set on the 5th update, the 2nd on the 10th update, and so
on. Setting <code>forget_rate = 0</code> means early parameter sets are never
forgotten.</p></dd>


<dt id="arg-forget-end">forget_end<a class="anchor" aria-label="anchor" href="#arg-forget-end"></a></dt>
<dd><p>The final iteration at which early parameter sets can
be forgotten. Setting <code>forget_rate = Inf</code> (the default) means that the
forgetting mechanism continues throughout the chains. Forgetting early
parameter sets becomes less useful once the chains have settled into the
posterior mode, so this parameter might be set as an estimate of how long
that would take.</p></dd>


<dt id="arg-adapt-end">adapt_end<a class="anchor" aria-label="anchor" href="#arg-adapt-end"></a></dt>
<dd><p>The final iteration at which we can adapt the multivariate
normal proposal. Thereafter the empirical variance-covariance matrix, its
scaling and its weight remain fixed. This allows the adaptation to be
switched off at a certain point to help ensure convergence of the chain.</p></dd>


<dt id="arg-pre-diminish">pre_diminish<a class="anchor" aria-label="anchor" href="#arg-pre-diminish"></a></dt>
<dd><p>The number of updates before adaptation of the scaling
parameter starts to diminish. Setting <code>pre_diminish = 0</code> means there is
diminishing adaptation of the scaling parameter from the offset, while
<code>pre_diminish = Inf</code> would mean there is never diminishing adaptation.
Diminishing adaptation should help the scaling parameter to converge
better, but while the chains find the location and scale of the posterior
mode it might be useful to explore with it switched off.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <code>mcstate_sampler</code> object, which can be used with
<a href="mcstate_sample.html">mcstate_sample</a></p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Much like the simple nested random walk sampler
<a href="mcstate_sampler_random_walk.html">mcstate_sampler_random_walk</a>, the strategy is to propose all the
shared parameters as a deviation from the current point in parameter space
as a single move and accept or reject as a block. Then we generate points
for all the region-specific parameters, compute the density and then
accept or reject these updates independently.  This is possible
because the change in likelihood in region A is independent from
region B.</p>
<p>The adaptive proposal algorithm of the non-nested adaptive sampler
<a href="mcstate_sampler_adaptive.html">mcstate_sampler_adaptive</a> is extended here to adaptively tune the variance
covariance matrix of each of these parameter chunks.</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

