<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Create a monty sampler — monty_sampler • monty</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Create a monty sampler — monty_sampler"><meta name="description" content="A monty_sampler object can be passed into monty_sample in
order to draw samples from a distribution.  The primary role of a
sampler is to advance the state of a Markov chain one step; in
doing so they may mutate some internal state (outside the
knowledge of the problem being advanced).  Ordinarily users will
not call this function, but authors of samplers will call it from
the constructor of their sampler."><meta property="og:description" content="A monty_sampler object can be passed into monty_sample in
order to draw samples from a distribution.  The primary role of a
sampler is to advance the state of a Markov chain one step; in
doing so they may mutate some internal state (outside the
knowledge of the problem being advanced).  Ordinarily users will
not call this function, but authors of samplers will call it from
the constructor of their sampler."><meta property="og:image" content="https://mrc-ide.github.io/monty/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">monty</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/monty.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Basics</h6></li>
    <li><a class="dropdown-item" href="../articles/dsl.html">Probabilistic DSL</a></li>
    <li><a class="dropdown-item" href="../articles/samples.html">Working with samples</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/dsl-errors.html">DSL parse errors</a></li>
    <li><a class="dropdown-item" href="../articles/samplers.html">Samplers</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migration from mcstate</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extending</h6></li>
    <li><a class="dropdown-item" href="../articles/writing-samplers.html">Writing samplers</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/monty/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Create a monty sampler</h1>
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/monty/blob/main/R/sampler.R" class="external-link"><code>R/sampler.R</code></a></small>
      <div class="d-none name"><code>monty_sampler.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>A <code>monty_sampler</code> object can be passed into <code>monty_sample</code> in
order to draw samples from a distribution.  The primary role of a
sampler is to advance the state of a Markov chain one step; in
doing so they may mutate some internal state (outside the
knowledge of the problem being advanced).  Ordinarily users will
not call this function, but authors of samplers will call it from
the constructor of their sampler.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">monty_sampler</span><span class="op">(</span></span>
<span>  <span class="va">name</span>,</span>
<span>  <span class="va">help</span>,</span>
<span>  <span class="va">control</span>,</span>
<span>  <span class="va">initialise</span>,</span>
<span>  <span class="va">step</span>,</span>
<span>  state_dump <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  state_combine <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  state_restore <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  state_details <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  properties <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-name">name<a class="anchor" aria-label="anchor" href="#arg-name"></a></dt>
<dd><p>Name of the sampler. Usually this is the name of the
algorithm and can include spaces and punctuation if desired.</p></dd>


<dt id="arg-help">help<a class="anchor" aria-label="anchor" href="#arg-help"></a></dt>
<dd><p>Name of the function to direct users to find help.
Usually that is the name of the constructor function.</p></dd>


<dt id="arg-control">control<a class="anchor" aria-label="anchor" href="#arg-control"></a></dt>
<dd><p>A list of control parameters passed to the sampler.
These are immutable (i.e., once created they cannot be changed).</p></dd>


<dt id="arg-initialise">initialise<a class="anchor" aria-label="anchor" href="#arg-initialise"></a></dt>
<dd><p>A function to initialise the sampler.  This is
called once at the start of the chain to set up any internal
state, though in some cases it will not need to do very much.
It must take arguments:</p><ul><li><p><code>state_chain</code>: the state of the MCMC chain, containing
elements <code>pars</code> (a vector or matrix of parameters), <code>density</code>
and possibly <code>observation</code></p></li>
<li><p><code>control</code>: the control parameters, as originally passed to
<code>monty_sampler</code></p></li>
<li><p><code>model</code>: the model being sampled from</p></li>
<li><p>the random number generator state, which the sampler may draw
from.</p></li>
</ul><p>Return <code>NULL</code> if your sampler is stateless, otherwise return an
environment (e.g., created with <code>new.env(parent = emptyenv())</code>
of state that will be updated at each iteration.  You can store
whatever is convenient in this, for example a random walk
sampler might store the eigendecomposition of a variance
covariance matrix used in the proposal here.</p></dd>


<dt id="arg-step">step<a class="anchor" aria-label="anchor" href="#arg-step"></a></dt>
<dd><p>The workhorse function of a sampler, propagating state
(the pair (parameters, density)) forward one step in the chain.
Typically, but not always, this will include a proposal,
evaluation of a density, and an acceptance.</p>
<p>It must take arguments:</p><ul><li><p><code>state_chain</code>: The state of the MCMC chain (as above)</p></li>
<li><p><code>state_sampler</code>: The state of the sampler, as passed back from
<code>init</code>.  If your sampler is stateless this is <code>NULL</code>,
otherwise it is an environment that you will modify by
reference.</p></li>
<li><p><code>control</code>: Sampler control parameters (as above)</p></li>
<li><p><code>model</code>: The model (as above)</p></li>
<li><p><code>rng</code>: The random number state, which you can use in the step
(as above)</p></li>
</ul><p>Return <code>state_chain</code>, updated after acceptance.</p></dd>


<dt id="arg-state-dump">state_dump<a class="anchor" aria-label="anchor" href="#arg-state-dump"></a></dt>
<dd><p>Optionally, a function to prepare the chain
state for serialisation.  If not given, we assume that nothing
needs to be saved and that your sampler can be restarted from
just the state of the chain, the model and <code>control</code>.  If
provided then typically you will need to provide
<code>state_restore</code>, too.</p></dd>


<dt id="arg-state-combine">state_combine<a class="anchor" aria-label="anchor" href="#arg-state-combine"></a></dt>
<dd><p>Optionally, a function to combine the output
of several chains (a list, where each element has come from
<code>state_dump</code>) into a single object that is consistent with what
the simultaneous runner would have produced.</p></dd>


<dt id="arg-state-restore">state_restore<a class="anchor" aria-label="anchor" href="#arg-state-restore"></a></dt>
<dd><p>Optionally, a function to take a dumped chain
state and convert it back into an environment.  If not given, we
assume that <code>list2env(x, parent = emptyenv())</code> is sufficient and
use that (unless your state is <code>NULL</code>, in which case we use
<code>identity</code>).  If provided then typically you will need to
provide <code>state_dump</code>, too.  The arguments here, if provided,
must be</p><ul><li><p><code>chain_id</code></p></li>
<li><p><code>state_chain</code></p></li>
<li><p><code>state_sampler</code></p></li>
<li><p><code>control</code></p></li>
<li><p><code>model</code></p></li>
</ul></dd>


<dt id="arg-state-details">state_details<a class="anchor" aria-label="anchor" href="#arg-state-details"></a></dt>
<dd><p>Optionally, a function to tidy internal state
to be saved at the end of the run.  If you provide this you
almost certainly need to provide <code>state_dump</code> and
<code>state_restore</code>.  This takes the combined state as its only
argument.</p></dd>


<dt id="arg-properties">properties<a class="anchor" aria-label="anchor" href="#arg-properties"></a></dt>
<dd><p>Optionally, a <a href="monty_sampler_properties.html">monty_sampler_properties</a> object
that advertises what your sampler can do and what it requires
from models that it draws samples from.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <code>monty_sampler</code> object</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>See <code><a href="../articles/writing-samplers.html">vignette("writing-samplers")</a></code> for an introduction to writing
samplers.</p>
<p>Control parameters are used to build the sampler.  These are
immutable after creation.  The format is unspecified by
<code>monty_sampler</code> but typically this will be a named list.  The
sampler designer will construct this list and should take care not
to include anything mutable (e.g. environments) or hard to
serialise and transfer to another process here.</p>
    </div>
    <div class="section level2">
    <h2 id="sampler-state">Sampler state<a class="anchor" aria-label="anchor" href="#sampler-state"></a></h2>
    <p>Your sampler can have internal state.  This is not needed for
simple samplers; a random walk Metropolis-Hastings sampler does
not need this for example as its state is entirely defined by the
(<code>pars</code>, <code>density</code>) pair that forms the chain state.  Similarly,
simple implementations of HMC or Gibbs samplers would not need this
functionality.  If you wish to record debug information, or if
your sampler updates some internal state as it runs – as our
adaptive Metropolis-Hastings sampler does – then you will need to
configure your sampler to initialise, store, combine and restore
this state.</p>
<p>There are four state handling functions.  If you provide one, you
probably will need to provide them all, though <code>details</code> can be
omitted if you do not want to render out a user-facing summary of
your sampler state at the end of a chain.</p><ul><li><p><code>state_dump</code>: this takes the sampler state (which is often an
environment) and returns a list.  In most cases, this is for a
single chain, but if your sampler is used with
<code><a href="monty_runner_simultaneous.html">monty_runner_simultaneous()</a></code> this will correspond to the state
for a number of chains at once, in which case your dumped state
should look like the output from combining chains.</p></li>
<li><p><code>state_combine</code>: this takes a list of sampler states, each of
which was dumped with <code>state_dump</code> and combines them into a
single state object.  You need to aim for the case where the
output of this function is the same as running <code>state_dump</code>
after running with <code><a href="monty_runner_simultaneous.html">monty_runner_simultaneous()</a></code>.  Hopefully we
can write some things to help with this, or at least example
tests that will probably satisfy this.</p></li>
<li><p><code>state_restore</code>: this takes the output of <code>state_split</code> (or
<code>state_combine</code> in the case of <code><a href="monty_runner_simultaneous.html">monty_runner_simultaneous()</a></code>)
and prepares the state for use with the sampler.  This function
takes arguments:</p><ul><li><p><code>chain_id</code>: one or more chain ids</p></li>
<li><p><code>state_chain</code>: the state of the chain(s) at the point of
restoration</p></li>
<li><p><code>state_sampler</code>: the state from <code>state_combine</code></p></li>
<li><p><code>control</code>: the sampler control</p></li>
<li><p><code>model</code>: the model</p></li>
</ul></li>
<li><p><code>state_details</code>: this takes the output of <code>state_combine</code> and
returns a cleaned version of the state back to the user, as the
<code>$details</code> element of the final samples.  Use this to extract a
fraction of the total state where only some should be
user-visible.  You do not need to provide this, the default is
to return nothing.</p></li>
</ul><p>State initialisation is handled by <code>initialise</code>; however, a
non-trivial return value from this function does not imply that
your sampler needs to worry very much about state.  If you can
entirely construct this from the current state of the chain and
the control parameters, then no state management is required.
However, a non-trivial return value from <code>initialise</code> requires a
<code>state_restore</code> argument, even if <code>state_dump</code> is not present.</p>
<p>The state manoeuvres may feel tedious, but it will form part of
the core of how the Parallel Tempering algorithm works, where we
need to be able to run multiple chains through a sampler at the
same time.</p>
<p>We will set things up soon so that if you do not provide these
functions (but if you do provide state), then your sampler will
work, but it will fail informatively when you try and continue it.</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Wes Hinsley, Ed Knock, Marc Baguelin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

