<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Migration from mcstate • monty</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Migration from mcstate">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">monty</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/monty.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Basics</h6></li>
    <li><a class="dropdown-item" href="../articles/dsl.html">Probabilistic DSL</a></li>
    <li><a class="dropdown-item" href="../articles/samples.html">Working with samples</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Details</h6></li>
    <li><a class="dropdown-item" href="../articles/dsl-errors.html">DSL parse errors</a></li>
    <li><a class="dropdown-item" href="../articles/samplers.html">Samplers</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migration from mcstate</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extending</h6></li>
    <li><a class="dropdown-item" href="../articles/writing-samplers.html">Writing samplers</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mrc-ide/monty/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Migration from mcstate</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/monty/blob/main/vignettes/migration.Rmd" class="external-link"><code>vignettes/migration.Rmd</code></a></small>
      <div class="d-none name"><code>migration.Rmd</code></div>
    </div>

    
    
<p><code>monty</code> is the spiritual replacement for <a href="https://mrc-ide.github.io/mcstate/" class="external-link"><code>mcstate</code></a>,
which was used for inference of <a href="https://mrc-ide.github.io/odin.dust/" class="external-link">odin.dust</a> models from
2020 to 2024.</p>
<p>Unlike with the new versions of <a href="https://mrc-ide.github.io/odin/" class="external-link"><code>odin</code></a> (<a href="https://mrc-ide.github.io/odin2/" class="external-link"><code>odin2</code></a>) and <a href="https://mrc-ide.github.io/dust/" class="external-link"><code>dust</code></a> (<a href="https://mrc-ide.github.io/dust2/" class="external-link"><code>dust2</code></a>), we have
not changed <code>mcstate</code> in place as we no longer felt that the
name was appropriate; mcstate was explicitly about working with state
space models, while <code>monty</code> is about Monte Carlo methods in
general. And Wes has a goat called Monty, so here we are.</p>
<div class="section level2">
<h2 id="where-is-everything">Where is everything?<a class="anchor" aria-label="anchor" href="#where-is-everything"></a>
</h2>
<p>Some features have moved out of this package and into
<code>dust2</code>:</p>
<div class="section level3">
<h3 id="the-particle-filter">The particle filter<a class="anchor" aria-label="anchor" href="#the-particle-filter"></a>
</h3>
<p>The particle filter has moved into <a href="https://mrc-ide.github.io/dust2" class="external-link"><code>dust2</code></a>, see <a href="https://mrc-ide.github.io/dust2/reference/dust_filter_create.html" class="external-link"><code>dust2::dust_filter_create</code></a></p>
<p>What was previously a method on the old <code>particle_filter</code>
object has now changed to be a free function:</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="28%">
<col width="38%">
</colgroup>
<thead><tr class="header">
<th>Action</th>
<th>mcstate</th>
<th>dust2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Allocate</td>
<td><code>$new()</code></td>
<td>
<code>dust_filter_create()</code> (1)</td>
</tr>
<tr class="even">
<td>Run</td>
<td><code>$run()</code></td>
<td><code>dust_likelihood_run()</code></td>
</tr>
<tr class="odd">
<td>Stateful run</td>
<td><code>$run_begin()</code></td>
<td>Not supported</td>
</tr>
<tr class="even">
<td>Get final state</td>
<td><code>$state()</code></td>
<td><code>dust_likelihood_last_state()</code></td>
</tr>
<tr class="odd">
<td>Get trajectories</td>
<td><code>$history()</code></td>
<td><code>dust_likelihood_last_trajectories()</code></td>
</tr>
<tr class="even">
<td>Get ODE statistics</td>
<td><code>$ode_statistics()</code></td>
<td>Not yet supported</td>
</tr>
<tr class="odd">
<td>Get intermediate state</td>
<td><code>$restart_state()</code></td>
<td>Not yet supported</td>
</tr>
<tr class="even">
<td>Get inputs</td>
<td><code>$inputs</code></td>
<td>Not yet supported</td>
</tr>
<tr class="odd">
<td>Change number of threads</td>
<td><code>set_n_threads()</code></td>
<td>Not supported</td>
</tr>
</tbody>
</table>
<ol style="list-style-type: decimal">
<li>Or <code>dust_unfilter_create</code> for deterministic models</li>
</ol>
<p>In addition, differentiable deterministic models have
<code>dust_likelihood_last_gradient()</code> to get the gradient of the
likelihood at the last point.</p>
</div>
<div class="section level3">
<h3 id="other-state-space-methods">Other state space methods<a class="anchor" aria-label="anchor" href="#other-state-space-methods"></a>
</h3>
<p>In mcstate, we implemented two other sequential Monte Carlo methods:
SMC^2 and IF2. Neither of these have been reimplemented yet, but these
will appear in dust if and when we do so. Please let us know if you used
these!</p>
</div>
</div>
<div class="section level2">
<h2 id="running-mcmc">Running MCMC<a class="anchor" aria-label="anchor" href="#running-mcmc"></a>
</h2>
<p>How these are specified and configured has totally changed, to the
point where it is not really meaningful to do a table-based comparison
of methods.</p>
<p>A typical use with mcstate looked like this (adapted with
simplification from the old <a href="https://mrc-ide.github.io/mcstate/articles/sir_models.html" class="external-link">SIR
models vignette</a>)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va">particle_filter</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>data <span class="op">=</span> <span class="va">...</span>, model <span class="op">=</span> <span class="va">...</span>, compare <span class="op">=</span> <span class="va">...</span>,</span>
<span>                                       n_particles <span class="op">=</span> <span class="va">...</span><span class="op">)</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu">pmcmc_parameter</span><span class="op">(</span><span class="st">"beta"</span>, <span class="fl">0.2</span>, min <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu">pmcmc_parameter</span><span class="op">(</span><span class="st">"gamma"</span>, <span class="fl">0.1</span>, min <span class="op">=</span> <span class="fl">0</span>, prior <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">p</span>, shape <span class="op">=</span> <span class="fl">1</span>, scale <span class="op">=</span> <span class="fl">0.2</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">proposal_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">mcmc_pars</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="va">pmcmc_parameters</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, gamma <span class="op">=</span> <span class="va">gamma</span><span class="op">)</span>,</span>
<span>                                           <span class="va">proposal_matrix</span><span class="op">)</span></span>
<span><span class="va">control</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu">pmcmc_control</span><span class="op">(</span></span>
<span>    <span class="va">n_steps</span>,</span>
<span>    save_state <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    save_trajectories <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu">mcstate</span><span class="fu">::</span><span class="fu">pmcmc</span><span class="op">(</span><span class="va">mcmc_pars</span>, <span class="va">filter</span>, control <span class="op">=</span> <span class="va">control</span><span class="op">)</span></span></code></pre></div>
<p>With monty this would look more like:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu">dust_filter_create</span><span class="op">(</span><span class="va">generator</span>, <span class="va">time_start</span>, <span class="va">data</span>, <span class="va">n_particles</span><span class="op">)</span></span>
<span><span class="va">packer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/monty_packer.html">monty_packer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"gamma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">dust_likelihood_monty</span><span class="op">(</span><span class="va">filter</span>, <span class="va">packer</span>,</span>
<span>                               save_state <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                               save_trajectories <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/monty_dsl.html">monty_dsl</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">beta</span> <span class="op">~</span> <span class="fu">Uniform</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">gamma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">1</span>, scale <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">sampler</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/monty_sampler_random_walk.html">monty_sampler_random_walk</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/monty_sample.html">monty_sample</a></span><span class="op">(</span><span class="va">model</span> <span class="op">+</span> <span class="va">prior</span>, <span class="va">sampler</span>, <span class="va">n_steps</span><span class="op">)</span></span></code></pre></div>
<p>which contains roughly the same bits of information but in quite a
different presentation:</p>
<p><strong>The way that parameters are specified</strong>: in
<code>mcstate</code> we had <code>pmcmc_parameter</code> and
<code>pmcmc_parameters</code>, one of which was a function and the other
was a combination that included the sampler’s proposal kernel! This is
all a bit silly. Now: * we use our <a href="https://mrc-ide.github.io/monty/reference/monty_packer.html">packer
interface</a> to smooth over the gap between how it is convenient to
represent parameters in your odin model and how you need to represent
them to think about moving around in parameter space * we use the DSL to
specify priors, removing the need to write out distributions, to sample
from these distributions automatically and to prevent forgetting the
<code>log = TRUE</code> on densities.</p>
<p><strong>The <code>pmcmc_control</code> object has gone</strong>: this
contained information that really affected the filter (e.g.,
<code>save_state</code> which has moved into the
<code>dust_likelihood_monty</code> function) and the running of the
chain itself.</p>
<p><strong>The control over samplers has moved into a new sampler
object</strong>: we needed this additional level of control to allow
different samplers to be used in different situations (e.g., to allow
HMC in the case of a deterministic differentiable density).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Wes Hinsley, Ed Knock, Marc Baguelin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
